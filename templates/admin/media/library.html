{% extends "admin/admin_base.html" %}

{% block title %}Biblioteca de Medios{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">Biblioteca de Medios</h1>
    <p class="page-description">Gestiona las im√°genes y archivos de tu sitio web.</p>
    <div class="page-actions">
        <button class="btn btn-primary" onclick="document.getElementById('fileUpload').click()">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v10M7 10h10"/>
            </svg>
            Subir Archivo
        </button>
    </div>
</div>

<!-- Formulario de subida (oculto) -->
<form method="POST" enctype="multipart/form-data" id="uploadForm" style="display: none;">
    {{ form.hidden_tag() }}
    <input type="file" id="fileUpload" name="file" accept="image/*" onchange="document.getElementById('uploadForm').submit()">
</form>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-body">
        <form method="GET" style="display: flex; gap: 1rem; align-items: end;">
            <div class="form-group" style="margin: 0; flex: 1;">
                <label for="search" class="form-label">Buscar</label>
                <input type="search" id="search" name="search" class="form-control" 
                       placeholder="Buscar por nombre..." 
                       value="{{ request.args.get('search', '') }}">
            </div>
            <button type="submit" class="btn btn-primary">Buscar</button>
            {% if request.args.get('search') %}
            <a href="{{ url_for('media_library') }}" class="btn btn-secondary">Limpiar</a>
            {% endif %}
        </form>
    </div>
</div>

<!-- Grid de Medios -->
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;">
    {% for file in files %}
    <div class="card" style="overflow: hidden;">
        <div style="aspect-ratio: 1; overflow: hidden; background: var(--light); display: flex; align-items: center; justify-content: center;">
            {% if file.is_image %}
            <img src="{{ file.url }}" alt="{{ file.filename }}" 
                 style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
            <div style="font-size: 3rem;">üìÑ</div>
            {% endif %}
        </div>
        <div class="card-body" style="padding: 1rem;">
            <div style="font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.5rem; word-break: break-all;">
                {{ file.filename|truncate(30) }}
            </div>
            <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.75rem;">
                {{ file.size_kb }} KB
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-sm btn-secondary" style="flex: 1;" 
                        onclick="copyToClipboard('{{ file.url }}')" 
                        title="Copiar URL">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="2" width="10" height="10" rx="1"/>
                        <path d="M5 2v2M5 11v2M2 5h2M11 5h2"/>
                    </svg>
                </button>
                <form method="POST" action="{{ url_for('admin.media_delete', file_id=file.id) }}" 
                      style="display: inline;"
                      onsubmit="return confirm('¬øEliminar este archivo?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-sm btn-danger" title="Eliminar">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h12M9 3v12M5 6v9a2 2 0 002 2h4a2 2 0 002-2V6"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card" style="grid-column: 1 / -1;">
        <div class="card-body" style="text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üñºÔ∏è</div>
            <div style="font-weight: 600; margin-bottom: 0.5rem;">No hay archivos todav√≠a</div>
            <div style="margin-bottom: 1.5rem; color: var(--text-light);">Sube tu primera imagen o archivo.</div>
            <button class="btn btn-primary" onclick="document.getElementById('fileUpload').click()">
                Subir Archivo
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<div style="background: var(--light); padding: 1rem; border-radius: 8px; margin-top: 1.5rem;">
    <div style="font-size: 0.875rem; color: var(--text);">
        <strong>üí° Tip:</strong> Haz clic en el bot√≥n de copiar para obtener la URL del archivo y usarla en tus contenidos.
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('URL copiada al portapapeles: ' + text);
        }).catch(err => {
            console.error('Error al copiar:', err);
        });
    }
</script>
{% endblock %}